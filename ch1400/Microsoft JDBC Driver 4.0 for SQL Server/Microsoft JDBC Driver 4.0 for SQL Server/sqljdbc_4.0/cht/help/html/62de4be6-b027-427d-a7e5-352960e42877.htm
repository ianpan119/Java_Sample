<html xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:mshelp="http://msdn.microsoft.com/mshelp" xmlns:ddue="http://ddue.schemas.microsoft.com/authoring/2003/5" xmlns:msxsl="urn:schemas-microsoft-com:xslt"><head><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8" /><META NAME="save" CONTENT="history" /><title>JDBC 驅動程式對於高可用性、災害復原的支援</title><meta name="Language" content="zh-cht" /><meta name="Microsoft.Help.Id" content="62de4be6-b027-427d-a7e5-352960e42877" /><meta name="Description" content="本主題討論 Microsoft JDBC Driver for SQL Server 對於高可用性、災害復原的支援 -- AlwaysOn 可用性群組。如需有關 AlwaysOn 可用性群組 的詳細資訊，請參閱《SQL Server 2012 線上叢書》。" /><meta name="Microsoft.Help.ContentType" content="Concepts" /><link rel="stylesheet" type="text/css" href="../local/Classic.css" /><script type="text/javascript" src="../scripts/EventUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/SplitScreen.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/Dropdown.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_manifold.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_feedBack.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CheckboxMenu.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CommonUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../local/script_main.js">&amp;nbsp;</script></head><body><div id="header"><table id="bottomTable" cellpadding="0" cellspacing="0"><tr><td align="left"><span id="headerBold">JDBC 驅動程式對於高可用性、災害復原的支援</span></td></tr></table><table id="gradientTable"><tr><td class="nsrBottom" background="../icons/gradient.gif" /></tr></table></div><div id="mainSection"><div id="mainBody"><div class="introduction"><p>本主題討論 Microsoft JDBC Driver for SQL Server 對於高可用性、災害復原的支援 -- AlwaysOn 可用性群組。如需有關 AlwaysOn 可用性群組 的詳細資訊，請參閱《SQL Server 2012 線上叢書》。</p><p>從 Microsoft JDBC Driver for SQL Server 4.0 版開始，您可以在連接屬性中指定 (高可用性、災害復原) 可用性群組 (AG) 的可用性群組接聽程式。如果 Microsoft JDBC Driver for SQL Server 應用程式連接到容錯移轉的 AlwaysOn 資料庫，則原始連接會中斷，而且應用程式必須開啟新的連接，才能在容錯移轉之後繼續工作。</p><p>如果您並未連接到可用性群組接聽程式，而且如果多個 IP 位址與伺服器有關聯，則 Microsoft JDBC Driver for SQL Server 會嘗試連接到第一個 IP 位址。如果 Microsoft JDBC Driver for SQL Server 無法建立與第一個 IP 位址的連接，則連接會失敗。Microsoft JDBC Driver for SQL Server 將不會嘗試連接與伺服器相關聯的任何後續 IP 位址。當連接到可用性群組接聽程式時，Microsoft JDBC Driver for SQL Server 會嘗試以平行方式建立與所有 IP 位址的連接，而且如果連接嘗試成功，則驅動程式會捨棄任何暫止的連接嘗試。</p><div style="margin: .5em 1.5em .5em 1.5em"><b></b><p>增加連接逾時及實作連接重試邏輯將會提高應用程式連接至可用性群組的機率。此外，由於連接會因為可用性群組容錯移轉而失敗，所以您應該實作連接重試邏輯，重試失敗的連接直到重新連接為止。</p></div><p>Microsoft JDBC Driver 4.0 for SQL Server 中已加入下列<a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">連接屬性</a>：</p><ul><li><p><span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span></p></li><li><p><span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span></p></li></ul></div><h1 class="heading">使用 MultiSubnetFailover 連接</h1><div id="sectionSection0" class="section" name="collapseableSection" style=""><p>當連接到 SQL Server 2012 可用性群組的可用性群組接聽程式或是 SQL Server 2012 容錯移轉叢集執行個體時，一定要指定 <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span>。<span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 會針對 SQL Server 2012 中的所有可用性群組和容錯移轉叢集執行個體啟用更快速的容錯移轉，而且會大幅減少單一和多重子網路 AlwaysOn 拓撲的容錯移轉時間。在多重子網路容錯移轉期間，用戶端會以平行方式嘗試連接。在子網路容錯移轉期間，Microsoft JDBC Driver for SQL Server 會以積極方式重試 TCP 連接。</p><p><span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 連接屬性表示應用程式正在可用性群組或容錯移轉叢集執行個體中部署，而且 Microsoft JDBC Driver for SQL Server 會嘗試連接到主要 SQL Server 執行個體上的資料庫，其方法是嘗試連接到所有 IP 位址。為連接指定 <span sdata="langKeyword" value="MultiSubnetFailover=true"><span class="keyword">MultiSubnetFailover=true</span></span> 時，用戶端會重試 TCP 連接，其速度比作業系統的預設 TCP 重新傳輸間隔更快。如此可在容錯移轉 AlwaysOn 可用性群組或 AlwaysOn 容錯移轉叢集執行個體之後更快速地重新連接，而且適用於單一和多重子網路可用性群組與容錯移轉叢集執行個體。</p><p>如需有關 Microsoft JDBC Driver for SQL Server 中連接字串關鍵字的詳細資訊，請參閱＜<span sdata="link"><a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">設定連接屬性</a></span>＞。</p><p>如果在連接到可用性群組接聽程式或容錯移轉叢集執行個體以外的項目時指定 <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span>，則可能會對效能產生負面影響，而且也不支援這樣的作法。</p><p>如果未安裝安全性管理員，則 Java Virtual Machine 會在一段有限期間快取虛擬 IP 位址 (VIP)，這在預設情況下是由您的 JDK 實作以及 Java 屬性 networkaddress.cache.ttl 和 networkaddress.cache.negative.ttl 所定義。如果已安裝 JDK 安全性管理員，則 Java Virtual Machine 將會快取 VIP，而且預設不會重新整理快取。您應該針對 Java Virtual Machine 快取將「存留時間」(networkaddress.cache.ttl) 設定為一天。如果您未將預設值變更為一天 (或一天左右)，則當加入或更新 VIP 時，將不會從 Java Virtual Machine 快取中清除舊的值。如需有關 networkaddress.cache.ttl 和 networkaddress.cache.negative.ttl 的詳細資訊，請參閱 <a href="http://download.oracle.com/javase/6/docs/technotes/guides/net/properties.html">http://download.oracle.com/javase/6/docs/technotes/guides/net/properties.html</a>。</p><p>使用以下指導方針連接到可用性群組中的伺服器或是容錯移轉叢集執行個體：</p><ul><li><p>如果在與 <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 連接屬性相同的連接字串中使用 <span sdata="langKeyword" value="instanceName"><span class="keyword">instanceName</span></span> 連接屬性，則驅動程式會產生錯誤。這反映以下事實：可用性群組中並未使用 SQL Browser。但是，如果同時指定了 <span sdata="langKeyword" value="portNumber"><span class="keyword">portNumber</span></span> 連接屬性，驅動程式將會忽略 <span sdata="langKeyword" value="instanceName"><span class="keyword">instanceName</span></span> 並使用 <span sdata="langKeyword" value="portNumber"><span class="keyword">portNumber</span></span>。</p></li><li><p>如果在連接到單一子網路或多重子網路時使用 <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 連接屬性，則會提高兩者的效能。</p></li><li><p>若要連接到可用性群組，請將可用性群組的可用性群組接聽程式指定為連接字串中的伺服器。例如，jdbc:sqlserver://VNN1。</p></li><li><p>連接到已設定 64 個以上 IP 位址的 SQL Server 執行個體將會造成連接失敗。</p></li><li><p>根據驗證的類型，使用 <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 連接屬性之應用程式的行為不會受到影響：SQL Server 驗證、Kerberos 驗證或 Windows 驗證。</p></li><li><p>提高 <span sdata="langKeyword" value="loginTimeout"><span class="keyword">loginTimeout</span></span> 的值來配合容錯移轉時間，並減少應用程式連接重試次數。</p></li><li><p>分散式交易不受支援。</p></li></ul><p>如果唯讀路由沒有作用，則連接到可用性群組中的次要複本位置會在以下情況發生失敗：</p><ol><li><p>未設定次要複本位置接受連接。</p></li><li><p>如果應用程式使用 <span sdata="langKeyword" value="applicationIntent=ReadWrite"><span class="keyword">applicationIntent=ReadWrite</span></span> (底下討論的內容)，而且次要複本位置已設定唯讀存取。</p></li></ol><p>如果設定主要複本來拒絕唯讀工作負載而且連接字串包含 <span sdata="langKeyword" value="ApplicationIntent=ReadOnly"><span class="keyword">ApplicationIntent=ReadOnly</span></span>，則連接將會失敗。</p></div><h1 class="heading">從資料庫鏡像升級來使用多重子網路叢集</h1><div id="sectionSection1" class="section" name="collapseableSection" style=""><p>如果您將目前使用資料庫鏡像的 Microsoft JDBC Driver for SQL Server 應用程式升級為多重子網路情況，您應該移除 <span sdata="langKeyword" value="failoverPartner"><span class="keyword">failoverPartner</span></span> 連接屬性，並以設定為 <span sdata="langKeyword" value="true"><span class="keyword">true</span></span> 的 <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 加以取代，然後使用可用性群組接聽程式來取代連接字串中的伺服器名稱。如果連接字串使用 <span sdata="langKeyword" value="failoverPartner"><span class="keyword">failoverPartner</span></span> 和 <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span>，則驅動程式會產生錯誤。但是，如果連接字串使用 <span sdata="langKeyword" value="failoverPartner"><span class="keyword">failoverPartner</span></span> 和 <span sdata="langKeyword" value="multiSubnetFailover=false"><span class="keyword">multiSubnetFailover=false</span></span> (或 <span sdata="langKeyword" value="ApplicationIntent=ReadWrite"><span class="keyword">ApplicationIntent=ReadWrite</span></span>)，則應用程式會使用資料庫鏡像。</p><p>如果在 AG 的主要資料庫上使用資料庫鏡像，而且在連接至主要資料庫 (而非可用性群組接聽程式) 的連接字串中使用 <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span>，則驅動程式會傳回錯誤。</p></div><h1 class="heading">指定應用程式的意圖</h1><div id="sectionSection2" class="section" name="collapseableSection" style=""><p>當 <span sdata="langKeyword" value="applicationIntent=ReadOnly"><span class="keyword">applicationIntent=ReadOnly</span></span> 時，用戶端會在連接至啟用 AlwaysOn 的資料庫時要求唯讀工作負載。伺服器會在連接時及 USE 資料庫陳述式期間強制施行此意圖，但是只限於啟用 AlwaysOn 的資料庫。</p><p><span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> 關鍵字無法用於傳統、唯讀資料庫。</p><p>資料庫可以允許或不允許目標 AlwaysOn 資料庫上的讀取工作負載 (這是利用 <span sdata="langKeyword" value="PRIMARY_ROLE"><span class="keyword">PRIMARY_ROLE</span></span> 和 <span sdata="langKeyword" value="SECONDARY_ROLE"><span class="keyword">SECONDARY_ROLE</span></span> Transact-SQL 陳述式的 <span sdata="langKeyword" value="ALLOW_CONNECTIONS"><span class="keyword">ALLOW_CONNECTIONS</span></span> 子句來完成)。</p><p><span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> 關鍵字是用來啟用唯讀路由。</p></div><h1 class="heading">唯讀路由</h1><div id="sectionSection3" class="section" name="collapseableSection" style=""><p>唯讀路由功能可確保資料庫之唯讀複本的可用性。若要啟用唯讀路由：</p><ol><li><p>您必須連接到 AlwaysOn 可用性群組的可用性群組接聽程式。</p></li><li><p><span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> 連接字串關鍵字必須設定為 <span sdata="langKeyword" value="ReadOnly"><span class="keyword">ReadOnly</span></span>。</p></li><li><p> 資料庫管理員必須設定可用性群組，才能啟用唯讀路由。</p></li></ol><p>使用唯讀路由的多個連接可能不會全部連接到相同的唯讀複本。資料庫同步處理或伺服器路由組態的變更可能導致用戶端連接至不同的唯讀複本。為了確保所有唯讀要求都連接到相同的唯讀複本，請勿將可用性群組接聽程式或虛擬 IP 位址傳遞給 <span sdata="langKeyword" value="serverName"><span class="keyword">serverName</span></span> 連接字串關鍵字。請改為指定唯讀執行個體的名稱。</p><p>唯讀路由所花的時間可能會比連接到主要複本所花的時間更長，因為唯讀路由會先連接到主要複本，然後尋找最佳可用的可讀次要複本。因此，您應該增加登入逾時。</p></div><h1 class="heading">支援 multiSubnetFailover 和 applicationIntent 的新方法</h1><div id="sectionSection4" class="section" name="collapseableSection" style=""><p>以下方法讓您能夠以程式設計方式存取 <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 和 <span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> 連接字串關鍵字：</p><ul><li><p><a href="19411e6c-c456-4533-8252-54569a2a6b1f.htm">SQLServerDataSource.getApplicationIntent</a></p></li><li><p><a href="e164c8ac-a0ae-4638-affb-ed454e7c0708.htm">SQLServerDataSource.setApplicationIntent</a></p></li><li><p><a href="1e8cb175-5f4c-4208-b4f5-3646990a30e3.htm">SQLServerDataSource.getMultiSubnetFailover</a></p></li><li><p><a href="7ffd282d-c2f6-4d1b-a7a6-859d18b388aa.htm">SQLServerDataSource.setMultiSubnetFailover</a></p></li><li><p><a href="b5eaad8a-31ef-44ac-af11-d5caa13ac3e2.htm">SQLServerDriver.getPropertyInfo</a></p></li></ul><p><span sdata="langKeyword" value="getMultiSubnetFailover"><span class="keyword">getMultiSubnetFailover</span></span>、<span sdata="langKeyword" value="setMultiSubnetFailover"><span class="keyword">setMultiSubnetFailover</span></span>、<span sdata="langKeyword" value="getApplicationIntent"><span class="keyword">getApplicationIntent</span></span> 和 <span sdata="langKeyword" value="setApplicationIntent"><span class="keyword">setApplicationIntent</span></span> 方法也加入至 <span sdata="link"><a href="097434fd-2b74-411c-a5ed-eba04481dde5.htm">SQLServerDataSource 類別</a></span>、<span sdata="link"><a href="b00e5a90-2af7-4d04-8ef8-256183777dcf.htm">SQLServerConnectionPoolDataSource 類別</a></span>和 <span sdata="link"><a href="95fc7b07-2498-4a7e-8f7f-ee0d86b598b4.htm">SQLServerXADataSource 類別</a></span>。</p></div><h1 class="heading">SSL 憑證驗證</h1><div id="sectionSection5" class="section" name="collapseableSection" style=""><p>可用性群組是由多個實體伺服器所組成。Microsoft JDBC Driver 4.0 for SQL Server 在 SSL 憑證中加入<span sdata="langKeyword" value="Subject Alternate Name"><span class="keyword">Subject Alternate Name</span></span>的支援，好讓多個主機可以與相同憑證產生關聯。如需有關 SSL 的詳細資訊，請參閱＜<span sdata="link"><a href="073f3b9e-8edd-4815-88ea-de0655d0325e.htm">了解 SSL 支援</a></span>＞。</p></div><span id="seeAlsoSpan"><h1 class="heading">請參閱</h1></span><div id="seeAlsoSection" class="section" name="collapseableSection" style=""><div class="seeAlsoStyle"><span sdata="link"><a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">設定連接屬性</a></span></div><div class="seeAlsoStyle"><span sdata="link"><a href="94bcfbe3-f00e-4774-bda8-bb7577518fec.htm">使用 JDBC 驅動程式連接到 SQL Server</a></span></div></div></div><div id="footer" class="section"><span id="feedbackarea">將有關本主題的<a href="javascript:SubmitFeedback('DevDocs@Microsoft.com','','','','8.0.12060.10000','%0\d感謝您的意見反應。開發人員撰寫小組會使用您的意見反應改善文件集。檢閱意見反應的同時，我們可能會傳送電子郵件給您要求提供進一步說明或是解決方案的意見。電子郵件地址不會用於任何其他目的，檢閱後將會刪除。%0\A如需有關%20Microsoft%20隱私權原則的詳細資訊，請參閱%20http://privacy.microsoft.com/zh-tw/default.aspx。%0\A%0\d','客戶回函');">意見反應</a>傳送給 Microsoft。</span><span id="copyrightarea"><p><a href="9bad553b-9e70-4696-8499-2e35f772a1e0.htm">© 2012 Microsoft.著作權所有，並保留一切權利。</a></p></span></div></div></body></html>